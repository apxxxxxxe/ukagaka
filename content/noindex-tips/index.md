## 💬「......」で口パクアニメーションしないようにしたい

### シェルの口パク

[surfaces.txt のアニメーションインターバル定義](http://ssp.shillest.net/ukadoc/manual/descript_shell_surfaces.html#introduction_animationinterval)には、トークに合わせて animation を動かすオプションの talk がある。
これを使うとトーク時に口を動かす表現ができる。  
ただし、これは「......」のようなセリフ的には無言の部分でも口が動いてしまう。

### 解決策

- 「......」をクイックセクションで囲む。

クイックセクションで表示された場所は一瞬で表示され、口パクの対象外になる。  
更に直後にウェイトを入れれば、表面上は通常通りの表示になる。つまり最終的には、

```{.prettyprint .lang-cs .linenums}
'\_q…\_w[500]…\_w[500]\_q'
```

みたいになる。その都度さくらスクリプトを仕込むのは大変なので、里々なら replace.txt、YAYA なら OnTranslate に置換処理を記述すると楽。

## 📊 連続して同じトークが来るのを避ける

たくさんのトーク群からどのようにトークを選び、喋らせるかはとても大事。自然なトーク選びができればゴーストの実在感、トークの没入感は高まる。  
トーク選びの基本処理は SHIORI がよしなにやってくれるけれど、デベ側からある程度ルールを設定することもできる。

### 前提

トーク被りを避け、出来るだけまんべんなくトークが選ばれるようにしたい。

#### 里々

『＄文「○」の重複回避』『＄単語群「○」の重複回避』を利用してトーク被りを回避できる。  
詳しくは[こちら](http://soliton.sub.jp/satori/index.php?%E7%89%B9%E6%AE%8A%E5%A4%89%E6%95%B0#o772b719)を参照

#### YAYA

関数のオプション「nooverlap」を指定することでトーク被りを回避できる。  
詳しくは[こちら](https://emily.shillest.net/ayaya/?%E3%83%9E%E3%83%8B%E3%83%A5%E3%82%A2%E3%83%AB/%E6%96%87%E6%B3%95/2.%E9%96%A2%E6%95%B0#vce5bec3)を参照

#### 提案:ルーレット選択アルゴリズムを実装する(YAYA)

- editing

##### 実装例

[Crave The Grave](https://github.com/apxxxxxxe/Haine/blob/main/ghost/master/yaya_rouletteselection.txt)

## 🍃 トーク文章の表示速度を辞書側で調整したい

SSP のデフォルト表示速度は
50ms/文字(ユーザ側で調整可能)。これをゴースト側から変更したいことがある  
（早口、ゆったりの表現や長い文章をゆっくり表示したいなど）

### 実現するための考え方

- 遅らせたい場合、１文字ごとにウェイト(\\\_w\[25\]など)を入れて表示速度を調整すればよい
- 早めたい場合は上記に加えてさくらスクリプト\\\_q
  でデフォルトのウェイトを消す必要がある

問題はどうやってウェイトを挿入するか

### 具体的な方法(YAYA)

<div>

```{.prettyprint .lang-cs .linenums}
AddWait
{
    // _argv[0]: 対象文字列
    // _argv[1]: ウェイト[ms]
    // メッセージスピードの標準は50ms これに加算すると考えて調整

    _text = _argv[0]
    _wait = '\_w[' + _argv[1] + ']'

    // 適当な制御文字 YAYAは0x0を扱えないので0x1で
    _tagmark = CHR(0x1)
    // さくらスクリプトは_tagmarkに置き換えて退避
    //(さくらスクリプト中にウェイト記述が挟まって破綻するのを防ぐ)
    // 置換したさくらスクリプトは配列に保持しておいて適宜取り出す
    _t = RE_REPLACE(_text, '\\_{0,2}[a-zA-Z0-9*!&\-+](\d|\[("([^"]|\\")+?"|([^\]]|\\\])+?)+?\])?', _tagmark)
    _tags = RE_GETSTR

    _tagcount = 0
    _textlen = STRLEN(_argv[0])
    _result = ""
    for _i=0; _i<_textlen; _i++ {
        _c = SUBSTR(_t, _i, 1)
        if _c == _tagmark {
            _result += _tags[_tagcount]
            _tagcount += 1
        }
        else {
            _result += _c + _wait // #1
        }
    }
    _result
}

```

</div>

これはトークを遅らせる場合。早めたい場合、#1 部分で単語を\\\_q で囲めばデフォルトのウェイトを無効化できる

## 🔙 トークを日本語的にいい感じのところで自動改行したい

### 改行の処理は面倒くさい

トークを書く時に気になるのが改行。文章の中途半端なところで改行が挟まると読みづらい。  
ちなみにバルーン「SSP デフォルト+」では１行に入る文字数は全角で 24 文字。見栄えを気にするなら毎行この制限を気にしつつ文章を考えることになるけれど、うまくいかないときもある。  
なんとかして自動でいい感じに処理できないだろうか？

### 文節を機械的に見分けて処理する

形態素解析ソフト MeCab を実装した
SAORI([kisaragi.dll](https://github.com/ponapalt/csaori))で文章を単語に分解し、各品詞から文節を割り出すことが可能。  
これを利用して、文章を文節ごとに改行する関数を作ろう。

### くわしい説明(YAYA)

- editing

### 実装例

[Crave The Grave](https://github.com/apxxxxxxe/Haine/blob/8f04e65e134431a3b2c6c884a35f287b5123d0bb/ghost/master/yaya_functions.txt#L168-L297)

## 🔖 栞を最新版にしよう

#### よい

- 新機能が使える
- バグが修正され、不自由/危険が解消される
- 最新版をつかっているという安心感

#### わるい

- めんどうくさい(複数ゴースト等を抱えていると特に)

#### 解決策

- [複数の栞ファイルを一括で更新するツール](https://github.com/apxxxxxxe/shioriupdater)を使う
